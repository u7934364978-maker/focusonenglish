# Technical Specification - Smart Exercise Generator Enhancements

## 1. Architecture Overview
The solution leverages the existing Next.js + Supabase + OpenAI stack. We will extend the database schema, enhance API prompts, and add sophisticated UI components for better interactivity.

## 2. Data Model Changes

### 2.1 New Table: `user_errors`
Used to track persistent mistakes for personalized practice.
```sql
CREATE TABLE user_errors (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  category TEXT NOT NULL, -- grammar, vocabulary, reading, etc.
  topic TEXT NOT NULL,    -- e.g., "Present Perfect", "Food"
  error_type TEXT,        -- "spelling", "conjugation", "syntax"
  wrong_answer TEXT,      -- The actual incorrect input
  correct_answer TEXT,    -- The expected answer
  count INTEGER DEFAULT 1,
  last_seen TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.2 Table Update: `user_stats`
Add fields for gamification.
```sql
ALTER TABLE user_stats 
ADD COLUMN IF NOT EXISTS current_streak INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS last_practice_date DATE;
```

## 3. API Enhancements

### 3.1 `api/generate-exercise` (POST)
- **New Context**: Fetch top 5 frequent errors from `user_errors` for the current user/category.
- **Prompt Injection**: Include these errors in the `systemPrompt` to ensure the AI creates exercises targeting those specific weaknesses.

### 3.2 `api/evaluate-response` (POST)
- **Structured Feedback**: Update OpenAI response format to include error metadata.
- **Schema**:
```json
{
  "success": true,
  "evaluation": {
    "score": number,
    "feedback": "string",
    "errors": [
      {
        "text": "incorrect part",
        "replacement": "correct part",
        "type": "grammar" | "vocabulary" | "spelling",
        "explanation": "why it's wrong",
        "start": number,
        "end": number
      }
    ],
    "nativeVersions": ["string"]
  }
}
```

### 3.3 `api/generate-audio` (POST)
- **Parameter**: `accent` (us, uk, au).
- **Service**: Map accent to specific voice IDs in Google Cloud TTS or ElevenLabs.

## 4. UI/UX Components

### 4.1 `SmartExerciseGenerator.tsx` Enhancement
- **State Machine**: Implement `difficulty` logic (3 correct -> up, 2 wrong -> down).
- **Timer**: Add a `useEffect` based countdown for Challenge Mode.
- **Streak Logic**: Track consecutive correct answers in local state and push to Supabase on session finish.

### 4.2 `FeedbackHighlighter.tsx` (New)
- Component that takes the user's string and the `errors` array from the API.
- Renders the string with `<mark>` or `<span>` tags at specified `start`/`end` indices.

### 4.3 `SentenceBuilder.tsx` (New)
- Drag-and-drop implementation using `framer-motion` or `dnd-kit`.
- Handles scrambled words generated by the AI.

## 5. Implementation Strategy

### Phase 1: Foundation & Gamification
1. Update Supabase schema.
2. Implement difficulty adjustment and XP multipliers in `SmartExerciseGenerator`.
3. Add Challenge Mode timer.

### Phase 2: Intelligence & Feedback
1. Update `evaluate-response` API and logic.
2. Create `FeedbackHighlighter` component.
3. Implement `user_errors` tracking.

### Phase 3: Multimedia & Modes
1. Update `generate-audio` for accents.
2. Implement `SentenceBuilder` and `Dictation` modes.

## 6. Verification
- **Unit Tests**: Test difficulty adjustment logic.
- **Integration Tests**: Verify error logging to Supabase.
- **Manual QA**: Verify AI feedback highlighting accuracy.
